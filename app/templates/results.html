{% extends "base.html" %}
{% block content %}

<div class="container mt-5">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ 'danger' if category == 'error' else category }} shadow-sm fade show">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div class="card shadow-sm">
    <div class="card-header bg-white border-bottom">
      <h2 class="card-title h4 mb-0">Validation Results</h2>
    </div>

    <div class="card-body">
      {% for result in results %}
        <div class="result-section p-4 mb-4 bg-light rounded-3">
          <h3 class="h5 mb-4 d-flex align-items-center">
            <i class="bi bi-file-earmark-excel me-2"></i>
            {{ result.filename }}
          </h3>

          <div class="row g-4">
            <div class="col-md-4">
              <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-danger bg-opacity-10 border-0">
                  <h4 class="h6 mb-0 text-danger">Missing Headers</h4>
                </div>
                <div class="card-body">
                  {% if result.missing_headers %}
                    <ul class="list-unstyled mb-0">
                    {% for header in result.missing_headers %}
                      <li class="py-1"><i class="bi bi-dash-circle text-danger me-2"></i>{{ header }}</li>
                    {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-muted mb-0">No missing headers</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-success bg-opacity-10 border-0">
                  <h4 class="h6 mb-0 text-success">Matched Headers</h4>
                </div>
                <div class="card-body">
                  {% if result.matched_headers %}
                    <ul class="list-unstyled mb-0">
                    {% for header in result.matched_headers %}
                      <li class="py-1"><i class="bi bi-check-circle text-success me-2"></i>{{ header }}</li>
                    {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-muted mb-0">No matched headers</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-warning bg-opacity-10 border-0">
                  <h4 class="h6 mb-0 text-warning">Extra Original Headers</h4>
                </div>
                <div class="card-body">
                  {% if result.extra_headers %}
                    <ul class="list-unstyled mb-0">
                    {% for header in result.extra_headers %}
                      <li class="py-1"><i class="bi bi-plus-circle text-warning me-2"></i>{{ header }}</li>
                    {% endfor %}
                    </ul>
                  {% else %}
                    <p class="text-muted mb-0">No extra headers</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4 d-flex gap-2">
            {% if result.missing_headers %}
              <button class="btn btn-primary d-flex align-items-center merge-btn" data-file-id="{{ result.file_id }}" data-filename="{{ result.filename }}" onclick="downloadFile('{{ result.file_id }}', '{{ result.filename }}')">
                <span class="spinner-border spinner-border-sm d-none me-2" role="status"></span>
                <i class="bi bi-download me-2"></i>
                Merge and Download
              </button>
            {% endif %}
          </div>
        </div>
      {% endfor %}

      <a href="{{ url_for('main.upload_file') }}" class="btn btn-outline-primary">
        <i class="bi bi-upload me-2"></i>
        Upload More Files
      </a>
    </div>
  </div>

  <script>
    function downloadFile(fileId, filename) {
      const button = document.querySelector(`button[data-file-id="${fileId}"]`);
      const spinner = button.querySelector('.spinner-border');

      spinner.classList.remove('d-none');
      button.disabled = true;

      fetch(`/merge_and_download/${fileId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.blob();
        })
        .then(blob => {
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          const originalName = filename.split('.')[0];
          a.download = `${originalName}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('Error downloading file. Please try again.');
        })
        .finally(() => {
          spinner.classList.add('d-none');
          button.disabled = false;
        });
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'alert alert-danger alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
      toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }
  </script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
</div>

{% endblock %}